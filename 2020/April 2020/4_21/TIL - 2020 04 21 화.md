# TIL - 2020 04 21 화

### bill thread

- 지폐 인식기 상태 판별 

- 지폐 받은 상태인지 아닌지 판별
- 받았다면 권종 파악
- 권종에 대한 보너스 계산
- 지폐를 받고 입수 가능 명령을 내림(지폐인식기 멈춤 방지) - threading.Timer
- 금액 화면 처리 
- 지폐 투입은 어느 상황에서 가능 

***

### [다음] button handling thread

- 충전화면의 [다음] 버튼과 발급화면의 [다음] 버튼을 핸들링 함
- 충전화면은 투입금액이 0원 이상이면 활성화 되며, 발급 화면은 환경설정의  “카드발급 최소금액” 이상이 되어야 활성화 된다.
- 해당 쓰레드는 예외처리가 필수다. (Tkinter 특성으로 이미지가 사라지거나 나올 때 문제 가 됨)

***

### RF reader thread

- 카드가 있는지 항상 체크하는 쓰레드
- 카드가 있다면 Flag를 검사한다.
- Flag는 총 4가지이며, 각각 충전, 조회, 발급, 초기화 Flag가 있다.
- 카드를 읽고 나서 연속적으로 읽지 않으며, 카드를 물리적으로 제거 한 후 다시 접촉하여야 카드를 읽을 수  있음 (이중충전 이슈에서 벗어나기 위함)
- RF 통신도 하나의 무선통신이며, 하드웨어에서 일어나는 동작이기 때문에 쓰레드내에서 writing 동작 시  ACS-1256U 리더기의 최대 통신속도인 250ms 만큼 딜레이가 있음
- 각각의 Flag가 활성화 되어있을 때 다른 Flag는 중지됨
- 실제로 이 쓰레드에서 UI를 제어하지 않고 Main의 UI 쓰레드가 해당 쓰레드의 값을 기반으로 UI를 제어함

***

### 각 Flag 별 설명

 ⓵ 충전 Flag가 활성화 되어 있으면 투입금액이 0원 이상일 경우 충전을 진행함

 ⓶ 조회 Flag가 활성화 되어 있으면 카드에 잔액을 변수에 저장함

 ⓷ 발급 Flag가 활성화 되어 있으면 투입금액이 0원 이상일 경우 하부 리더기에서 충전을 진행함

 ⓸ 초기화 Flag가 활성화 되어 있으면 카드 초기화 모드를 실행항

***

### pyscard thread

- 참고 사이트 
  - [Github - smartcard - CardObserver sample](https://github.com/LudovicRousseau/pyscard/blob/master/smartcard/CardMonitoring.py)



### 카드 메모리 이슈 - New

- 터치충전기
  - 카드 금액 초기화 현상
    - 관리자 메뉴에서 카드 저장 번지 (binary_block) 바꿀 수 있게 설정해보는 것도 나쁘지 않을듯 하다
    - 혹시나 리더기에서 빈 번지를 읽어서 기존 금액이랑 안맞는 현상 방지하기 위해 발상함