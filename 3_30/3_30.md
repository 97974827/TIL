## __1. 전체 프로그램 로직__

- __데이터 수집장치와 포스는 http 통신을 사용한다.__

- 실시간 485 데이터 이력은 포스가 지속적으로 요청하고 있다. 

- 데이터 수집장치는 실시간 데이터 이력을 지속적으로 응답을 해주고 있다.

  - Ex) 10개 장비 중에 장비 하나가 이상일 경우 
    - 데이터 수집장치에서는 나머지 장비 데이터를 저장하고 있다.
    - 포스에서는 나머지 장비 데이터를 띄워준다.

  

- 이 때 실시간 데이터는 데이터 수집장치가 DB에 저장하지 않고 포스에 __리턴값__을 http 통신으로 전해주는 방식이다. 

  - http 통신을 사용했을때 특징
    - 데이터 수집장치는 포스에 데이터를 전달만 한다. (단방향)
    - 실시간 통신에 매우 불리하다. (과부하 걸리기 쉬움)
    - 포스에 있는 기능들(조회, 설정, 충전..)은 필요한 경우에 요청함으로써 HTTP에 적합



## 2. 실시간 모니터링

- 모니터링 해야될 기기가 많아져도 실시간으로 보이게끔 만든건데 실제로 실시간은 아니다. 

- 데이터 수집장치

  - 두 가지 실시간 호출 방식이 있음

    - 포스에서 메인화면으로 진입할 때마다 동작상태 호출을 진행함 
    - 포스에서 실시간 모니터링 기능으로 진입할 때 동작상태 호출을 진행함 

    

  - 485 기기에게 동작상태 호출 프로토콜을 지속적으로 송신한다.  --> 1초에 한번씩 보냄

  - 485 기기에게 받은 수신 프로토콜을 전부 리턴값으로 받음



- 포스
  - 해당 매장 장비수량에 맞게 설정후 실시간 모니터링 기능에서 장비 하나씩 데이터 수집장치에 지속적으로 리턴값을 요청하여 순차적으로 실시간 데이터를 띄우는 방식





## 3. 문제점



- 포스에서 실시간 모니터링 기능 들어갔을 때 데이터 수집장치의 리턴값을 제대로 받지 못해 

- 모니터링 장비가 많을 때 시리얼 통신값을 줄이면  실시간 데이터를 못 받을 때가 종종 발생해 장비 판넬이 띄워지지 않음 

- 시리얼 통신값 늘리면 모니터링이 늦게뜬다.

- 모든 장비 사용 내역은 저장 잘됨 , 포스의 실시간 모니터링 데이터만 현상이 나옴 

  

- 원인

  - 485 장비 자체에서 수신 프로토콜 값중에 간혹 쓰레기값으로 오는 경우가 있는데 이 문자 값을 데이터 수집장치에서 디코딩 변환을 못 시켜주고 있다. (예외상황이 났을 시에는 한 루프를 종료하고 1초후 다시 실행)



- 실시간 데이터를 __"지속적"__ 으로 호출 했을 때 문제점

  - 지금의 상황처럼 데이터를 못 받을 때가 있다.
  - 수집장치에 과부하 문제가 생길 수 있다. 

  

- 실시간 데이터를 __"한 번만"__ 호출 했을 떄 문제점

  - 실시간 데이터를 원활하게 받을 수 없다.
  - 사용자 입장에서 불편함을 느낄 수 있다.
  
  

***



## 4. 현재 프로젝트에 대해 궁금한 점 입니다 

1. 원인 : 수신 프로토콜을 serial read 쪽에서 decoding utf-8 변환문제 

   - 해본 시도 

     -  수신 문자 값하나하나 읽는데 값이 바이트로 b'G' 이런식으로 와야하는데 텍스트값이 아닌 hex값형식 b'\xd7' , b'\xcc' 이렇게 와서 디코딩 변환을 못함 --> 파이썬 쉘에서 확인함
     - (485 -> DB 의심되서) 대진셀프 485 컨트롤 데이터 값 확인 (환경 : 윈도우, Commop(시리얼 툴)) --> 정상동작
     - 에러 로그 --> [google] 485 쓰레기값 검색 --> 에러 내용 그대로 검색 
       From get_device_state for 485 :  'utf-8' codec can't decode byte 0xfc in position 0: invalid start byte 
       From get_device_state for 485 :  'utf-8' codec can't decode byte 0xe0 in position 0: unexpected end of data
       From get_device_state for charger_state except :  'utf-8' codec can't decode byte 0xf3 in position 0: unexpected end of data
       From get_device_state for 485 :  'utf-8' codec can't decode byte 0x9b in position 0: invalid start byte
     - 제 생각에는 디코딩 변환 부분이 문제인거 같아서 쉘에서 내용 확인해봤더니  
       serial read 쪽에서 값이 b'G' 형식이 아닌 b'\xdc' b'\xe7' 이런 형식으로 응답이 왔습니다  
       바이트 코드로 인코딩, 디코딩 변환할때 'utf-8'로 동일하게 변환시킨걸 확인 했는데 
       검색해서 봐도 어디서 문제인지 잘 모르겠어서 왜 이런 에러 메시지가 나오는지 모르겠습니다 피드백 좀 받을 수 있을까요?

     

     1-4. 노이즈가 발생해서 잘못된 값을 디코딩을 안하고 그냥 버려버린 거같음 

   ```
   -> 데이터 저장 잘되고 프로그램 잘돌아감
   -> 통신상태가 안 좋은걸 프로그램에서 커버 하는게 힘듬..
   ```

   

   ***

   

2. __제 생각에는 232컨버터에 종단저항을 달아야 한다고 생각되는데__ 사장님께서는 응답온거 자체로 판단하여 485통신에는 문제가 없다고 말씀하시는데 서버에서 원인 잡으라고 하셨어요.. 시리얼 응답값이 잘못온걸 서버에서 잡는게 힘들다고 생각하는데 어떤 방법이 좋을까요?

